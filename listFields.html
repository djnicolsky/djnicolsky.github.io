<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>List of fields</title>
		
		<script src="editablegrid/editablegrid.js"></script>
		<!-- [DO NOT DEPLOY] --> <script src="editablegrid/editablegrid_renderers.js" ></script>
		<!-- [DO NOT DEPLOY] --> <script src="editablegrid/editablegrid_editors.js" ></script>
		<!-- [DO NOT DEPLOY] --> <script src="editablegrid/editablegrid_validators.js" ></script>
		<!-- [DO NOT DEPLOY] --> <script src="editablegrid/editablegrid_utils.js" ></script>
		<!-- [DO NOT DEPLOY] --> <script src="editablegrid/editablegrid_charts.js" ></script>
		<link rel="stylesheet" href="editablegrid/editablegrid.css" type="text/css" media="screen">
		
		<script src="editablegrid/extensions/jquery/jquery-1.6.4.min.js" ></script>
		<script src="editablegrid/extensions/jquery/jquery-ui-1.8.16.custom.min.js" ></script>
		<link rel="stylesheet" href="editablegrid/extensions/jquery/jquery-ui-1.8.16.custom.css" type="text/css" media="screen">
		<script src="field.js"></script>

        <link rel="stylesheet" type="text/css" href="simple.css" media="screen"/>
		
		<script>
			window.onload = function() {

				// this approach is interesting if you need to dynamically create data in Javascript
				var metaField = [];
				metaField.push({ name: "name", label: "Label", datatype: "string", editable: true});
				metaField.push({ name: "type", label:"Type", datatype: "string", editable: true});
				metaField.push({ name: "F1", label:"F(x)/F(r)", datatype: "string", editable: true});
				metaField.push({ name: "F2", label:"F(y)", datatype: "string", editable: true});
				metaField.push({ name: "F3", label:"F(z)", datatype: "string", editable: true});
				metaField.push({ name: "S1", label: "Sx/Sr", datatype: "double", editable: true});
				metaField.push({ name: "S2", label: "Sy/S_phi", datatype: "double", editable: true});
				metaField.push({ name: "S3", label: "Sz/S_psi", datatype: "double", editable: true});
				metaField.push({ name: "crd", label:"Coordinate", datatype: "string", editable: true});
				metaField.push({ name: "action", label: "D/D", datatype: "html", editable: false});

				metaField[1].values = {"E":"Electric", "B":"Magnetic", "G":"Gravity", "K":"Friction"};
				metaField[8].values = {"C":"Cartesian", "S":"Spherical"};


				FieldGrid = new EditableGrid("3DSpaceFields");
				var newArray = [];
				for(var i=0; i<parent.opener.fields.length; i++){
					var tmp = parent.opener.fields[i].returnValues();
					newArray.push({name: 'values', values: JSON.parse(JSON.stringify(tmp))});
				}
				FieldGrid.load({"metadata": metaField, "data": newArray});
				//FieldGrid.load({"metadata": metaField, "data": parent.opener.fields});
                var af = new CellRenderer({render: function(cell, value) {
		     		cell.innerHTML = "<a onclick=\"if (confirm('Are you sure you want to delete this field? ')) FieldGrid.remove(" + cell.rowIndex + ");\" style=\"cursor:pointer\">" +
			    					 "<img src=\"delete.png\" border=\"0\" alt=\"delete\" title=\"delete\"/></a>";
		         	cell.innerHTML+= "&nbsp;<a onclick=\"FieldGrid.duplicate(" + cell.rowIndex + ");\" style=\"cursor:pointer\">" +
		                         	 "<img src=\"duplicate.png\" border=\"0\" alt=\"duplicate\" title=\"duplicate\"/></a>";
		       	}});
                FieldGrid.setCellRenderer("action", af);
				FieldGrid.renderGrid("tableFields", "testgrid");

				FieldGrid.modelChanged = function(rowIndex, columnIndex, oldValue, newValue, row) { 
					if((this.getColumnName(columnIndex)=='crd')&&(newValue=='S'))
						for(var i=3;i<5;i++) this.setValueAt(rowIndex,i,'N/A');
					if((this.getColumnName(columnIndex)=='crd')&&(newValue=='C'))
						for(var i=3;i<5;i++) this.setValueAt(rowIndex,i,'0');		
				};

				for (var r = 0; r < this.FieldGrid.getRowCount(); r++) {
            		var values = this.FieldGrid.getRowValues(r);
            		if(values['crd'] == 'S')
            			for(var i=3;i<5;i++) this.FieldGrid.setValueAt(r,i,'N/A');
            	}
			}

            EditableGrid.prototype.duplicate = function(rowIndex)
            {
            	// copy values from given row
            	var values = this.getRowValues(rowIndex);
            	values['name'] = values['name'] + ' (copy)';

            	var newRowId = 0;
            	for (var r = 0; r < this.getRowCount(); r++) 
            		newRowId = Math.max(newRowId, parseInt(this.getRowId(r)) + 1);
            	this.insertAfter(rowIndex, newRowId, values);
            };

            function applyChanges(){
            	for(var i=this.parent.opener.fields.length-1; i>=0; i--)
            			this.parent.opener.fields.splice(i,1);

            	for (var r = 0; r < this.FieldGrid.getRowCount(); r++) {
            		var values = this.FieldGrid.getRowValues(r);
					this.parent.opener.addNewField(values);
            	}
            	window.close();
 				return true;
			}

            function applyChanges2(){
            	for(var i=0; i<this.parent.opener.fields.length; i++)
            		this.parent.opener.fields[i].toBeRemoved = 1;

            	for (var r = 0; r < this.FieldGrid.getRowCount(); r++) {
            		var values = this.FieldGrid.getRowValues(r);
            		var toBeAdded = true;
            		for(var i=0; i<this.parent.opener.fields.length; i++)
            			if(this.parent.opener.fields[i].name==values.name){
            				this.parent.opener.fields[i].updateParameters(values);
            				this.parent.opener.fields[i].toBeRemoved = 0;
            				toBeAdded = false;
            			}
            		if(toBeAdded)
            			this.parent.opener.addNewField(values);
            	}
            	for(var i=this.parent.opener.fields.length-1; i>=0; i--)
            		if(this.parent.opener.fields[i].toBeRemoved == 1)
            			this.parent.opener.fields.splice(i,1);

            	window.close();
 				return true;
			}

			function addNewField(){

				var values={};
				values.name="test_"+Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 8);
				values.type="G"; values.crd="C";
				values.F1="0"; values.F2="0"; values.F3="0";
				values.S1="0"; values.S2="0"; values.S3="0";

				var newRowId = 0;
            	for (var r = 0; r < this.FieldGrid.getRowCount(); r++) 
            		newRowId = Math.max(newRowId, parseInt(this.FieldGrid.getRowId(r)) + 1);

				this.FieldGrid.insertAfter(this.FieldGrid.getRowCount(), newRowId, values);
 				return true;
			}

		</script>		
	</head>
	
	<body>
		<div id="tableFields"></div>
		<button onclick="return addNewField();">Add</button>
		<input type="submit" value="Submit" onclick="return applyChanges();"/>
		<button type="cancel" onclick="window.close();">Cancel</button>
    </body>

</html>
